#!/usr/bin/perl

use POSIX ":sys_wait_h";
use strict;
use warnings;
use NanoMsg::Raw;
#use Test::More;

my $socket_address = 'ipc:///tmp/pubsub.ipc';
my $pid = fork();
$|=1;
if(not $pid) {
    print "Hello";
    my $sub = nn_socket(AF_SP, NN_SUB);
    nn_setsockopt( $sub, NN_SUB, NN_SUB_SUBSCRIBE, '' );
    nn_connect($sub, $socket_address);
    my $buf;
    nn_recv($sub, $buf);
    print "Buf: $buf";
 #   is $buf, "dsfs";
 #   is 1, 2;
    nn_close $sub;
}
else {
    sleep 2;
    my $pub = nn_socket(AF_SP, NN_PUB);
    nn_connect $pub, $socket_address;
    for(1..100){
	nn_send($pub, "$_");
    }

    print "Waiting for child to finish";
    while (wait() != -1) {}
    nn_close $pub;
}


